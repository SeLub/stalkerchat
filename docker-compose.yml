services:
  db:
    image: postgres:16
    env_file: .env
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - pgdata:/var/lib/postgresql/data
    ports:
      - "${DB_HOST_PORT}:5432"

  redis:
    image: redis:7-alpine
    command: redis-server --requirepass ${REDIS_PASSWORD}
    env_file: .env
    ports:
      - "${REDIS_HOST_PORT}:6379"

  pgadmin:
    image: dpage/pgadmin4
    env_file: .env
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_DEFAULT_EMAIL}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_DEFAULT_PASSWORD}
    ports:
      - "${PGADMIN_HOST_PORT}:80"
    depends_on:
      - db

  redisinsight:
    image: redis/redisinsight:latest
    ports:
      - "${REDIS_INSIGHT_HOST_PORT}:8001"
    depends_on:
      - redis

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    env_file:
      - .env          # for host ports (optional)
      - ./backend/.env  # for app config
    ports:
      - "${BACKEND_HOST_PORT}:4000"  # host:container
    depends_on:
      - db
      - redis

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    ports:
      - "${FRONTEND_HOST_PORT}:3000"
    volumes:
      - ./frontend:/app
      - /app/node_modules
    environment:
      # Important: frontend needs to know where backend is on HOST
      VITE_BACKEND_URL: http://host.docker.internal:${BACKEND_HOST_PORT}
      VITE_WEBSOCKET_URL: ws://host.docker.internal:${BACKEND_HOST_PORT}
    # On Linux (without Docker Desktop), use:
    # extra_hosts:
    #   - "host.docker.internal:host-gateway"
volumes:
  pgdata: